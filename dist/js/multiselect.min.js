angular.module("am.multiselect",[]).factory("optionParser",["$parse",function(e){return{parse:function(n){var l=n.match(/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+([\s\S]+?)$/);if(!l)throw new Error('Expected typeahead specification in form of "_modelValue_ (as _label_)? for _item_ in _collection_" but got "'+n+'".');return{itemName:l[3],source:e(l[4]),viewMapper:e(l[2]||l[1]),modelMapper:e(l[1])}}}}]).directive("amMultiselect",["$parse","$document","$compile","$interpolate","$filter","optionParser",function(e,n,l,t,r,a){return{restrict:"E",require:"ngModel",link:function(n,i,c,u){function o(){V.items.length=0;var e=k.source(n);if(!angular.isUndefined(e))for(var l=0;l<e.length;l++){var t={};t[k.itemName]=e[l],V.items.push({label:k.viewMapper(t),model:k.modelMapper(t),checked:!1})}}function s(e,n){for(var l=0;l<e.length;l++)if(e[l].model==n)return e[l].label}function d(){if(f(u.$modelValue))return V.header=angular.isDefined(c.msHeader)?c.msHeader:"Select";if(x)if(c.msSelected)V.header=t(c.msSelected)(V);else if(1==u.$modelValue.length)for(var e=0;e<V.items.length;e++)V.items[e].model===u.$modelValue[0]&&(V.header=V.items[e].label);else V.header=u.$modelValue.length+" selected";else if(angular.isString(u.$modelValue))V.header=s(V.items,u.$modelValue);else{var n={};n[k.itemName]=u.$modelValue,V.header=k.viewMapper(n)||s(V.items,u.$modelValue)}}function f(e){if(angular.isNumber(e))return!1;if(e&&e.length&&e.length>0)return!1;for(var n in e)if(e[n])return!1;return!0}function m(e){e.checked?V.uncheckAll():(V.uncheckAll(),e.checked=!e.checked),p(!1)}function h(e){e.checked=!e.checked,p(!0)}function p(e){var n=void 0;e?(n=[],angular.forEach(V.items,function(e){e.checked&&n.push(e.model)}),0==n.length&&(n=void 0)):angular.forEach(V.items,function(e){if(e.checked)return n=e.model,!1}),u.$setViewValue(n)}function g(e){angular.isArray(e)?angular.forEach(V.items,function(n){n.checked=!1,angular.forEach(e,function(e){angular.equals(n.model,e)&&(n.checked=!0)})}):angular.forEach(V.items,function(n){if(angular.equals(n.model,e))return V.uncheckAll(),n.checked=!0,p(!1),!1})}var $=u.$isEmpty;u.$isEmpty=function(e){return $(e)||angular.isArray(e)&&0==e.length};var v=c.options,k=a.parse(v),x=!!c.multiple,b=!!c.hover,w=!1,V=n.$new(),y=c.change||angular.noop;V.items=[],V.header="Select",V.multiple=x,V.disabled=!1,V.searchDisable=!1,V.onBlur=c.ngBlur||angular.noop,V.hoverText=b?V.header:"",V.onFocus=c.ngFocus,V.clazz=c.clazz,n.$on("$destroy",function(){V.$destroy()});var E=angular.element("<am-multiselect-popup"+(c.templateUrl?' template-url="'+c.templateUrl+'"':"")+"></am-multiselect-popup>");(c.required||c.ngRequired)&&(w=!0),c.$observe("required",function(e){w=e}),V.$watch(function(){return e(c.ngDisabled)(n)},function(e){V.disabled=e}),V.$watch(function(){return e(c.searchDisable)(n)},function(e){V.searchDisable=e}),V.$watch(function(){return e(c.multiple)(n)},function(e){x=e||!1}),V.$watch(function(){return k.source(n)},function(e){angular.isDefined(e)&&o()},!0),V.$watch(function(){return u.$modelValue},function(e){angular.isUndefined(e)||""===e||null===e?(V.uncheckAll(),angular.isDefined(V.searchText)&&(V.searchText.label="")):angular.isDefined(e)&&(g(e),V.$eval(y)),d(),V.hoverText=b?V.header:"",u.$setValidity("required",V.valid())},!0),o(),i.append(l(E)(V)),V.valid=function(){if(!w)return!0;var e=u.$modelValue;return angular.isArray(e)&&e.length>0||!angular.isArray(e)&&null!=e},V.checkAll=function(){if(x){var e=V.searchText&&V.searchText.label.length>0?r("filter")(V.items,V.searchText):V.items;angular.forEach(e,function(e){e.checked=!0}),p(!0)}},V.uncheckAll=function(){angular.forEach(V.items,function(e){e.checked=!1}),p(V.multiple)},V.select=function(e){!1===x?(m(e),V.toggleSelect()):h(e)}}}}]).directive("amMultiselectPopup",["$document","$filter",function(e,n){return{restrict:"E",scope:!1,replace:!0,templateUrl:"html/multiselect.tmpl.html",link:function(l,t){function r(n){a(n.target,t.find(n.target.tagName))?l.$parent.$eval(l.onBlur):(t.removeClass("open"),e.unbind("click",r),l.$apply())}l.selectedIndex=null,l.isVisible=!1,l.filteredItems=null,l.ngClazz={error:!l.valid()},l.ngClazz[l.$eval(l.clazz)]=!0,l.toggleSelect=function(){t.hasClass("open")?(t.removeClass("open"),e.unbind("click",r),l.$parent.$eval(l.onBlur)):(t.addClass("open"),e.bind("click",r),l.focus())},l.evalFocus=function(){l.$parent.$eval(l.onFocus)},l.focus=function(){var e=t.find("input")[0];e&&e.focus()},l.keydown=function(e){var t=n("filter")(l.items,l.searchText),r=e.keyCode||e.which;13===r?t[l.selectedIndex]&&l.select(t[l.selectedIndex]):l.selectedIndex=38===r?null===l.selectedIndex?t.length-1:l.selectedIndex-1:40===r?null===l.selectedIndex?0:l.selectedIndex+1:null,l.selectedIndex<0?l.selectedIndex=t.length-1:l.selectedIndex>t.length-1&&(l.selectedIndex=0)};var a=function(e,n){for(var l=0;l<n.length;l++)if(e==n[l])return!0;return!1}}}}]);